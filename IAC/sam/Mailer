const { Client } = require('pg');
const AWS = require('aws-sdk');

const ses = new AWS.SES({ region: 'us-east-2' });

exports.handler = async (event) => {
    // PostgreSQL connection details
    const client = new Client({
        host: process.env.DB_HOST,
        user: process.env.DB_USER,
        password: process.env.DB_PASS,
        database: process.env.DB_NAME,
        port: process.env.DB_PORT,
    });

    try {
        // Connect to PostgreSQL database
        await client.connect();

        // Retrieve email templates and recipient addresses from the table
        const res = await client.query('SELECT recipient, subject, body FROM email_templates;');
        const emails = res.rows;

        // Iterate through emails and send each one using AWS SES
        for (const email of emails) {
            const params = {
                Destination: {
                    ToAddresses: [email.recipient],
                },
                Message: {
                    Body: {
                        Text: {
                            Data: email.body,
                            Charset: 'UTF-8',
                        },
                    },
                    Subject: {
                        Data: email.subject,
                        Charset: 'UTF-8',
                    },
                },
                Source: 'info@happyhippo.ai',
            };

            await ses.sendEmail(params).promise();
        }

        console.log('Emails sent successfully');
    } catch (error) {
        console.error('Error:', error);
    } finally {
        // Close the PostgreSQL connection
        await client.end();
    }
};
